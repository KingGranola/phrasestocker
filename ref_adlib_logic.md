# 🎷 アドリブ生成ロジック (Ad-lib Generation Logic)

本ドキュメントでは、アプリケーション内のAIフレーズ生成機能（`PhraseGenerator`）で使用されているロジックについて解説します。

## 🔄 全体フロー

フレーズ生成は `services/phraseGenerator.ts` の `generatePhrase` 関数をエントリーポイントとして、以下の手順で実行されます。

1.  **設定の読み込み**: ユーザーが指定したスタイル（Bebop/Contemporary）、密度、対象小節を受け取ります。
2.  **小節ごとの処理**: 対象となる各小節について、コード進行に基づきフレーズを生成します。
3.  **コードごとの処理**: 小節内の各コードに対して、以下のステップを実行します。
    - **スケール選択**: コードシンボルから使用可能なスケールを決定。
    - **ターゲット音選択**: 次のコード（またはフレーズの終わり）に向けた解決音（ターゲット）を決定。
    - **パス生成**: 現在の音からターゲット音へ向かう旋律（パス）を生成。
4.  **音符データへの変換**: 生成されたMIDIノート番号を、アプリ内で扱える `NoteData` 形式（キー、長さ、タブ譜位置など）に変換します。
5.  **デュレーション調整**: 小節内の拍数が正しくなるよう（例: 4/4拍子なら4拍）、必要に応じて休符を挿入したり、音価を調整したりします。

---

## 🎼 詳細ロジック

### 1. スケール選択 (`scaleDefinitions.ts`)

コードシンボル（例: `Cmaj7`, `G7alt`）を解析し、ジャズ理論に基づいて適切なスケール候補を返します。

| コードタイプ | 対応スケール候補 |
| :--- | :--- |
| **Major 7** (`maj7`, `△`) | Ionian, Lydian |
| **Minor 7** (`m7`) | Dorian, Minor Pentatonic |
| **Dominant 7** (`7`) | Mixolydian, Altered, HMP5 Down, Combination Diminished, Whole Tone |
| **Minor 7(b5)** (`m7b5`) | Locrian, Locrian #2 |
| **Diminished** (`dim`) | Diminished (Whole-Half) |

### 2. ターゲット音選択 (`targetLogic.ts`)

「次のコード」の構成音（コードトーン）の中から、現在の音から滑らかに繋がる最適な音を選びます。

-   **ガイドトーン優先**: 3度（3rd）や7度（7th）を優先的にターゲットとします。
-   **ボイスリーディング**: 現在の音から近い音（半音または全音での接続）を選び、跳躍を避けます。
-   **優先度**:
    -   High: 3rd, 7th
    -   Medium: Root, 5th

### 3. パス生成 (`pathfinding.ts`)

現在の音からターゲット音までの間を埋める旋律を生成します。ここで「スタイル」設定が大きく影響します。

#### 🎹 スタイルによる違い

ユーザーが選択したスタイル（0〜100）に応じて、生成されるフレーズの特性が変化します。

-   **Bebop Style (0 - 33)**
    -   **特徴**: 密度の高い8分音符、半音階的アプローチ（クロマチック）、アルペジオの多用。
    -   **ロジック**:
        -   ターゲットが遠い場合: アルペジオやスケールで接近。
        -   ターゲットが近い場合: クロマチック・アプローチ（半音下/上からの解決）を多用。
        -   確率的に「囲い込み（Enclosure）」のような動きを模倣。

-   **Modern Style (33 - 66)**
    -   **特徴**: スケール順次進行とアルペジオのバランス型。
    -   **ロジック**: 標準的なジャズフレーズ。極端な跳躍や過度なクロマチックを抑え、スケールに忠実な動き。

-   **Contemporary Style (66 - 100)**
    -   **特徴**: 広い音程（4度、5度、7度などの跳躍）、アウトサイドな響き。
    -   **ロジック**:
        -   意図的に広いインターバル（Intervalic）を選択。
        -   スケール外の音や、テンションノートを強調するような動き。

### 4. デュレーション（音価）管理

生成された音符の合計拍数が、小節の拍数（Time Signature）と厳密に一致するように調整されます。

-   **不足時**: 残りの拍数を計算し、適切な休符（四分休符、八分休符など）で埋めます。
-   **超過時**: （現状のロジックでは発生しないように制御されていますが）小節内に収まるようにカットされます。

---

## 🎵 3連符 (Triplet) の表記と計算

3連符とは、ある長さの音符を3等分するリズムです。

### 定義
- **1拍3連**: 4分音符（1拍）を3等分 → 8分音符3つに「3」の記号
- **2拍3連**: 2分音符（2拍）を3等分 → 4分音符3つに「3」の記号
- **4拍3連**: 全音符（4拍）を3等分 → 2分音符3つに「3」の記号

### 計算方法
3連符は「元の音価の2/3」として計算します。
- 8分音符の基本音価 = 0.5拍
- 8分音符の3連符 = (0.5 × 2) / 3 = 0.333...拍
- つまり、8分3連符3つ = 1拍

### 注意点
- 平等に3等分することが重要
- 3連符は4分音符1つ分の時間を3つに分けたもの
- 8分音符2つとは異なるリズム（2等分 vs 3等分）

## 🛠 今後の拡張予定

-   **リズムパターンの多様化**: 現状は8分音符主体ですが、3連符や付点音符などの複雑なリズム生成。
-   **モチーフ展開**: 前の小節のアイデアを発展させるロジック。
-   **アウトサイド演奏の強化**: 一時的に半音ずらしたキーで演奏するなどの高度なジャズ手法の実装。

-----

# 🚀 ジャズフレーズ自動生成ロジック仕様書 Ver 5.0

**〜楽器特性（Guitar/Bass）に基づく物理制約と運指最適化〜**

本仕様書は、生成された音符列に対し、**「ギター・ベースで再現可能か（Playability）」**というフィルタリングと最適化を行うためのロジックを定義します。

## 1. 楽器別・音域（Range）定義

生成されるMIDIノートナンバーを、楽器の物理的な限界と「おいしい音域」に制限します。

### 1.1. エレキベース (4弦)

- **基本チューニング:** E1, A1, D2, G2
- **絶対音域:** E1 (MIDI 28) 〜 Eb4 (MIDI 63) ※20フレット想定
- **モード別推奨レンジ:**
    - **Walking Mode:** E1 〜 A2 (低音域重視。ルート感と安定感を出すため)
    - **Solo Mode:** A2 〜 D4 (高音域重視。メロディが抜けて聴こえる音域)
    - **制約:** E1未満の音（Low-B等）は、5弦ベースフラグがOFFの場合は生成しない。

### 1.2. エレキギター (6弦)

- **基本チューニング:** E2, A2, D3, G3, B3, E4
- **絶対音域:** E2 (MIDI 40) 〜 E6 (MIDI 88) ※22フレット想定
- **モード別推奨レンジ:**
    - **Comping Mode:** A2 〜 E4 (中低音域。ボイシングの密集を避ける)
    - **Solo Mode:** G3 〜 C6 (中高音域。サックス等の音域に近いゾーン)

## 2. 指板マッピング・ロジック (Fretboard Topology)

『水野式 ベースの新指板図理論塾』の概念を導入し、**「指板上の幾何学的な位置（ポジション）」**に基づいて次に出す音を決定します。

### 2.1. ポジション・ブロック・システム (The Box System)

指板を「4フレット＋1（人差し指〜小指＋ストレッチ）」のブロックに分割し、現在のハンド・ポジションを定義します。

- **Logic:**
    - 現在のポジション変数 `Current_Pos` (例: 5フレット) を保持する。
    - 次の音符は、原則として `Current_Pos` から `Current_Pos + 4` の範囲内にある弦・フレットを選択する。
    - **シフト・ペナルティ:** この範囲を超える移動（ポジション・チェンジ）には「コスト」を付与し、頻繁な移動を抑制する。

### 2.2. 異弦同音の選択アルゴリズム

ギターやベースには同じ高さの音が複数の場所に存在します。これを以下の優先順位で決定します。

1.  **同ポジション優先:** 現在のハンド・ポジション内で弾ける弦を選択。
2.  **音色統一:**
    - **Bass:** 太い音を維持するため、可能な限り太い弦（3, 4弦）のハイポジションよりも、細い弦（1, 2弦）のローポジションを避ける傾向を持たせる（またはその逆、ジャンルによる）。
    - **Guitar:** ソロのレガートフレーズでは、弦移動を減らす（同じ弦でスライドする）か、逆にスウィープのために隣接弦に移るかをスタイル指定で分岐させる。

### 2.3. 「水野式」シェイプ・データベース

コードトーンやスケールを「音名」ではなく「指板上の形（Shape）」として保持します。

- **データ構造例:**
    - `Shape_Major7_Root4String`: `[(0,0), (0,4), (1,3), (2,4)]`
        - (相対弦, 相対フレット) のリスト。ルート位置からの相対座標で管理。
- **適用:**
    - コードが `Cmaj7` で、ルートが `3弦3フレット(C)` にある場合、上記シェイプを適用して構成音の場所を特定する。これにより「運指的に無理のないアルペジオ」が保証される。

## 3. 運指（Fingering）に基づく生成制約

「理論的には正しいが、指が追いつかないフレーズ」を回避するためのルールです。

### 3.1. インターバル跳躍制限

- **ルール:** 弦飛び（String Skipping）は最大「1本またぎ」までとする。
    - *OK:* 4弦 $\to$ 2弦
    - *NG:* 4弦 $\to$ 1弦 （※低速なアルペジオやタッピング時を除く）
- **修正ロジック:** 禁止された跳躍が発生した場合、着地音をオクターブ上げる/下げる、または間の音（パッシング・ノート）を経由させる。

### 3.2. 開放弦の利用 (Open String Utilization)

- 特定のキー（E, A, D, Gなど）では、開放弦（0フレット）を積極的にルートやペダル・トーンとして利用するロジックを有効化する。

## 4. ベースライン専用生成ロジック (Bass Specifics)

『ベース・ライン完全攻略』および『ツー・ファイブ・ジャズ・ライン』に基づく、ベーシスト特有の思考プロセスを実装します。

### 4.1. ルート・モーションの強固さ

- **強拍の掟:** 小節の頭（1拍目）は、直前の音が何であれ、強引にでもルート（または5度）に戻る力が働く。
- **ライン生成フロー:**
    1.  `Beat 1`: Root (必須)
    2.  `Beat 4`: 次の小節のRootへのアプローチ音 (半音下/上、5度など) を決定。
    3.  `Beat 2, 3`: 上記2点をつなぐ経過音（スケールまたはアルペジオ）で埋める。

### 4.2. "Drop" と "Fill"

- **Drop:** 音域が高くなりすぎた場合（G弦ハイポジションなど）、フレーズの切れ目で一気に1オクターブまたは2オクターブ下へ「落下」させるロジック。
- **Fill (おかず):** コードが2小節以上続く場合（Long Chord）、ルート弾きを止め、高音域へ駆け上がるアルペジオや、3連符のリズム・モチーフを挿入する。

## 5. 実装用データ構造 (JSON Example)

楽器の物理特性を定義する設定ファイル例です。

```json
{
  "instrument_constraints": {
    "bass_4string": {
      "tuning": [28, 33, 38, 43], // E1, A1, D2, G2 (MIDI)
      "max_fret": 20,
      "preferred_position_width": 4, // 1-finger-per-fret
      "string_skip_penalty": 2.0,    // Cost for skipping strings
      "position_shift_penalty": 1.5  // Cost for shifting hand
    },
    "guitar_standard": {
      "tuning": [40, 45, 50, 55, 59, 64], // E2...E4
      "max_fret": 22,
      "preferred_position_width": 5,
      "shapes": {
        "major7_root6": [[0,0], [1,2], [2,1], [3,2]], // Visual shape relative to root
        "minor7_root6": [[0,0], [0,3], [1,2], [2,2]]
      }
    }
  },
  "generation_rules": {
    "bass_walking": {
      "beat1_lock": "root",
      "beat4_target": "next_root",
      "approach_types": ["chromatic", "dominant", "scale"]
    }
  }
}
```

## 6. 総合生成プロセス (Updated Flow)

1.  **理論フェーズ:** コード進行と理論に基づき、理想的な音列（ピッチクラス）を生成する（Ver 4.0までのロジック）。
2.  **マッピングフェーズ:** 生成された音列を、指定楽器（ギター/ベース）の指板上にマッピングする。
    - ここで「音域外」の音はオクターブ調整される。
3.  **コスト計算フェーズ:** 複数の運指候補（同音異弦）から、移動コスト（フレット移動距離＋弦移動距離）が最小になるルートを探索する（ダイクストラ法などを応用）。
4.  **フィルタリング:** 物理的に不可能な動き（指が届かない和音や跳躍）があれば、音符を削除または変更して修正する。
5.  **出力:** 演奏可能なMIDIデータまたはタブ譜として出力。

これにより、理論的に高度でありながら、実際のプレイヤーが「弾いていて気持ちいい」「運指が腑に落ちる」フレーズが出力されます。

