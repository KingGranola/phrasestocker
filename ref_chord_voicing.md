
# 🎹 コードボイシングとボイスリーディングのルール

このドキュメントでは、PhraseStocker+ アプリケーションにおけるコード再生の仕組み、特に「ボイスリーディング（声部の滑らかな連結）」のルールについて解説します。

---

## 1. ボイシングの基本モード

アプリケーションは、`MixerPanel` で選択されたモードに応じて、基本的な構成音を決定します。

### 🎵 Closed（クローズド・ボイシング） - **Default**
*   **構造**: 音域を1オクターブ以内に収めた密集配置。
*   **構成音**: Root, 3rd, 5th, 7th (またはテンション)
*   **特徴**: 最も基本的で、音の厚みがあります。今回の「ボイスリーディング」機能の主な対象です。

### 🎵 Shell（シェル・ボイシング）
*   **構造**: ジャズピアノの左手でよく使われる、必要最小限の配置。
*   **構成音**: Root, 7th, 3rd (または 10th)
*   **特徴**: 5度を省略し、コードの機能（トライトーン）を明確にします。

### 🎵 Rootless（ルートレス・ボイシング）
*   **構造**: ルート音を省略した、ビル・エヴァンス・スタイルの配置。
*   **構成音**: 3rd, 5th, 7th, 9th (テンションを含む)
*   **特徴**: ベースがルートを弾く前提の、洗練された響きです。

### 🎵 Drop 2（ドロップ・ツー）
*   **構造**: クローズド・ボイシングの上から2番目の音を1オクターブ下げた配置。
*   **特徴**: ギターで演奏しやすい、広がりのある響きです。

---

## 2. スムース・ボイスリーディング (Smooth Voice Leading)

バージョン 2.x 以降、コード進行に合わせて自動的に最適な**転回形 (Inversion)** を選択する機能が実装されました。

### 🎯 目的
コードが変わる際、構成音の跳躍を最小限に抑え、プロの伴奏のような滑らかなつながり（コネクション）を実現します。

### 📏 アルゴリズムの概要

1.  **候補の生成**:
    *   次のコードの基本形（ルートポジション）を作成します。
    *   それを転回させ、複数のバリエーション（転回形）を生成します。
        *   基本形: [C, E, G, B]
        *   第1転回形: [E, G, B, C]
        *   第2転回形: [G, B, C, E] ... など

2.  **距離の計算**:
    *   直前に鳴っていたコードの構成音（MIDIノート番号）と、生成した各候補との「距離」を計算します。
    *   距離は「構成音の平均ピッチ（重心）の差」として定義されます。

3.  **最適解の選択**:
    *   距離が最も小さい（＝指の移動が最も少ない）転回形を採用します。

### 💡 具体例: II-V-I 進行 (Dm7 -> G7 -> CM7)

#### ボイスリーディングなしの場合
すべてルートポジションで演奏されるため、音が大きく跳躍します。

1.  **Dm7**: D3, F3, A3, C4
2.  **G7**: G3, B3, D4, F4 (大きく下がる)
3.  **CM7**: C3, E3, G3, B3 (また下がる)

#### ボイスリーディングありの場合 (今回実装)
共通音を保持し、変化する音も最短距離で移動します。

1.  **Dm7**: D3, F3, A3, C4 (基本形)
2.  **G7**: D3, F3, G3, B3 (第2転回形)
    *   *D3, F3 が共通音として残る*
    *   *C4 -> B3 (半音下降)*
3.  **CM7**: C3, E3, G3, B3 (基本形)
    *   *G3, B3 が共通音*
    *   *D3 -> C3 (全音下降), F3 -> E3 (半音下降)*

---

## 3. 音域の制限 (Range Constraint)

*   **センター・ピッチ**: 中央ド (Middle C / MIDI 60) 周辺
*   **ルール**:
    *   最初のコード（前のコード情報がない場合）は、平均ピッチが **F3 (MIDI 53) 〜 C5 (MIDI 72)** の範囲に収まるように自動的にオクターブ調整されます。
    *   これにより、コードが極端に低い音で濁ったり、高すぎて存在感が薄れたりするのを防ぎます。

---

## 4. 適用範囲

現在の仕様では、以下のボイシングモードでのみスムース・ボイスリーディングが適用されます。

*   **Closed**: 最も効果的です。
*   **Rootless**: テンションを含むため、スムーズな連結が非常に重要です。

※ `Shell` や `Drop 2` は、特定の楽器（ギター等）の物理的な制約や定石フォームを重視するため、自動転回は適用されず、固定フォームで演奏されます。

