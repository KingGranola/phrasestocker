
# PhraseStocker 機能仕様書

**バージョン**: 2.0
**最終更新日**: 2025-02-24

本ドキュメントは、ジャズフレーズ作成支援ツールの機能的要件、音楽理論ロジック、およびインタラクションの仕様を定義するものです。特定の技術スタックやUIレイアウトには依存しません。

---

## 1. アプリケーション概要

**目的**:
ギタリストおよびベーシストが、ジャズの語法に基づいたフレーズを作成、保存、学習するためのツール。五線譜とTAB譜の同時編集、および音楽理論に基づくコード進行の提案を特徴とする。

---

## 2. 楽器定義と物理仕様

アプリケーションは以下の2つの楽器モードをサポートする。

### 2.1 ギターモード (Guitar)
- **弦構成**: 6弦 (E-A-D-G-B-E)
- **開放弦ピッチ (MIDI)**: [64(E4), 59(B3), 55(G3), 50(D3), 45(A2), 40(E2)] ※1弦から順に記述
- **有効音域**: E2 (MIDI 40) 〜 E6 (MIDI 88)
- **記譜ルール (移調)**:
  - ト音記号 (Treble Clef) を使用。
  - **実音より1オクターブ高く記譜する**（譜面の「中央ハ(C4)」は、実音の「C3」として発音）。
  - TAB譜生成および音声再生時は、この移調（-12半音）を適用して処理する。

### 2.2 ベースモード (Bass)
- **弦構成**: 4弦 (G-D-A-E)
- **開放弦ピッチ (MIDI)**: [43(G2), 38(D2), 33(A2), 28(E1)] ※1弦から順に記述
- **有効音域**: E1 (MIDI 28) 〜 G4 (MIDI 67)
- **記譜ルール (移調)**:
  - ヘ音記号 (Bass Clef) を使用。
  - **実音より1オクターブ高く記譜する**（ベースは移調楽器であるため）。
  - 譜面表示上の位置と実音のズレ（-12半音）を内部で処理する。

---

## 3. 楽譜エディタ機能

### 3.1 譜面構成
- **五線譜とTAB譜の同期**: 五線譜上の操作は即座にTAB譜に反映され、逆もまた然りとする。
- **拍子**: 4/4拍子固定。
- **調号 (Key Signature)**: 全12キー（五度圏順）に対応。
- **小節管理**: 任意の小節数に変更可能。

### 3.2 入力・編集モード (MuseScoreスタイル準拠)

システムは以下の3つの入力モードを持つ。

| モード名 | トリガー | 挙動 |
|:---|:---|:---|
| **音符入力 (Note Entry)** | キー: `N` | カーソル位置にゴーストノートを表示。クリックで音符を確定。 |
| **選択 (Select)** | キー: `Esc` | 音符の選択、移動、削除、プロパティ変更を行う基本モード。 |
| **TAB編集 (Tab Edit)** | キー: `T` | 音程（ピッチ）を変えずに、運指（弦・フレットの組み合わせ）のみを変更するモード。 |

### 3.3 音符入力仕様
- **音価選択**:
  - 全音符 (Key: `1`)
  - 二分音符 (Key: `2`)
  - 四分音符 (Key: `4`) ※デフォルト
  - 八分音符 (Key: `8`)
  - 十六分音符 (Key: `16`)
- **修飾**:
  - **付点 (Key: `.`)**: 音価を1.5倍にするトグル。
  - **3連符 (Key: `3`)**: 選択した音価を3連符として入力するトグル。
- **休符入力**:
  - モード切替 (Key: `0`) で休符モードとする。
  - クリック位置に関わらず、休符は五線譜の中央（第3線）に配置される。
- **アーティキュレーション**:
  - **タイ (Key: `L`)**: 同音程の音符を結合し、音を切らずに演奏する。
  - **スラー (Key: `Shift+L`)**: 異なる音程間を滑らかに演奏する。

### 3.4 編集操作
- **ピッチ変更**: 選択状態で `↑` / `↓` キー。半音階的に上下させる。
- **クロマチック運指変更**:
  - `Ctrl + ↑`: 音程を維持したまま、より細い弦（高い弦）へポジション移動。
  - `Ctrl + ↓`: 音程を維持したまま、より太い弦（低い弦）へポジション移動。
- **削除**: `Delete` または `Backspace`。

### 3.5 記譜ルール (自動処理)
- **符幹 (Stem) の向き**:
  - 第3線より上の音符は下向き、下の音符は上向きを原則とする。
  - TAB譜の符幹は、リズム視認性向上のため下向きで統一する。
- **連桁 (Beaming)**:
  - 8分音符以下の音符は、拍の区切り（1拍単位）に基づいて自動的に連桁でグループ化する。
- **臨時記号**:
  - 現在のキー署名に基づき、必要な場合のみ `#`, `b`, `♮` を自動付与する。

---

## 4. TAB譜生成ロジック

五線譜上の音符からTAB（弦・フレット）を決定するアルゴリズムは以下の優先順位に従う。

1.  **物理的実現性**: その音程を出せる弦・フレットの組み合わせを全列挙する。
2.  **ローポジション優先**: 開放弦〜4フレット付近を優先的に選択する（スコア加算）。
3.  **運指の連続性**: 直前の音符が存在する場合、そこからの物理的距離（弦移動コスト＋フレット移動コスト）が最小になるポジションを選択する。

**例外処理**:
- ユーザーが「TAB編集モード」またはショートカットで手動指定した運指は「固定」され、再計算時も維持される。

---

## 5. 音楽理論エンジン

### 5.1 コード進行の動的提案
設定された **Key** と **Scale (Major/Minor)** に基づき、ジャズ理論（JAZZ STANDARD THEORY準拠）に従って使用可能なコードをカテゴリ別に提示する。

#### Major Scale 時のカテゴリ
1.  **ダイアトニック**: 基本的な7つのコード (I△7, IIm7, etc.)。
2.  **セカンダリー・ドミナント**: 一時的な転調感を作るドミナント (V7/II, V7/V, etc.)。
3.  **裏コード (Sub V)**: ドミナントの代理 (bII7, etc.)。
4.  **モーダル・インターチェンジ**: 同主短調からの借用 (IVm7, bVI△7, etc.)。
5.  **ディミニッシュ**: パッシング・ディミニッシュ (#Idim7, etc.)。
6.  **スペシャル**: ブルース由来のドミナント (I7, IV7)。

#### Minor Scale 時のカテゴリ
自然的・和声的・旋律的短音階を統合して提案する。
1.  **ダイアトニック (基本)**: Im7, IIm7(b5), bIII△7, etc.
2.  **マイナー機能拡張**: Im6, Im(maj7) など、Melodic Minor由来のトニック。
3.  **セカンダリー**: V7/iv など。

### 5.2 度数解析 (Degree Analysis)
- 任意の瞬間に鳴っている「コード」と、入力された「メロディ音」の音程関係をリアルタイムで計算し、ラベルとして表示する。
- **表示形式**: R, b9, 9, b3, 3, 11, #11, 5, b13, 13, b7, 7。
- これにより、ユーザーは「自分がコードに対して何の音を使っているか（コードトーンか、テンションか、アボイドか）」を視覚的に理解できる。

---

## 6. バリデーション機能

### 6.1 リズム整合性チェック
- 各小節内の音符・休符の長さの合計を計算する。
- **ルール**: 合計値は拍子記号（4/4 = 4.0拍）と完全に一致しなければならない。
- **エラー処理**:
  - 合計 > 4.0: 「拍数超過」エラー。該当小節を強調表示し、これ以上の音符追加をブロックする。
  - 合計 < 4.0: 「拍数不足」警告。

### 6.2 音域チェック
- 入力された音符が、選択中の楽器（ギター/ベース）の物理的な最低音・最高音を超えている場合、入力を拒否または警告を表示する。

---

## 7. 再生機能 (Audio Engine)

### 7.1 ポリフォニック再生
- **メロディパート**: 入力された譜面データを、指定された楽器音色（ギター/ベース/ピアノ等）で再生する。
- **コードパート**: 配置されたコードシンボルを解析し、構成音（Root, 3rd, 5th, 7th, Tensions）に展開してバッキングとして再生する。

### 7.2 ミキサー機能
- メロディとコードそれぞれの「音量」と「音色」を個別に調整可能とする。
- **BPM制御**: テンポを可変とする。

---

## 8. データ管理・出力

### 8.1 保存と管理
- 作成したフレーズデータ（音符、コード、メタデータ）を永続化保存する。
- ライブラリ一覧から、過去のフレーズを検索・読み込み・削除可能とする。

### 8.2 エクスポート
以下の標準フォーマットでの書き出しに対応する。
1.  **Standard MIDI File (.mid)**:
    - Track 1: メロディ（指定楽器のProgram Change適用）
    - Track 2: コードバッキング
2.  **MusicXML (.musicxml)**:
    - 譜面描画ソフト（MuseScore, Finale等）との互換性確保用。
    - 五線譜データに加え、TAB譜情報（弦・フレット）、コードシンボルを含める。

---

## 9. 操作ショートカット一覧

| キー操作 | 機能 |
|:---|:---|
| `N` | 音符入力モード 切替 |
| `S` | 選択モードへ戻る |
| `T` | TAB編集モード 切替 |
| `1`〜`8` | 音価選択 (1:全, 2:二分, 4:四分, 8:八分) |
| `.` | 付点 トグル |
| `3` | 3連符 トグル |
| `0` | 休符モード トグル |
| `L` | タイ (Tie) |
| `Shift + L` | スラー (Slur) |
| `Space` | 再生 / 停止 |
| `Ctrl + Z` | 元に戻す (Undo) |
| `Ctrl + Shift + Z` | やり直し (Redo) |
| `Delete` | 選択音符の削除 |
| `↑` / `↓` | 音高の変更（半音単位） |
| `Ctrl + ↑` / `↓` | 弦（ポジション）の変更 |
